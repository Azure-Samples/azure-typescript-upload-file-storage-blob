# Azure Developer CLI configuration for v2 deployment
name: azure-upload-file-storage
metadata:
  template: azure-upload-file-storage@2.0.0
  description: Modern file upload application with managed identity and user delegation SAS tokens

services:
  api:
    project: ./azure-upload-file-storage/api
    language: js
    host: containerapp
    docker:
      path: ./Dockerfile
      context: ./
    env:
      - name: NODE_ENV
        value: production
      - name: PORT
        value: 3000
      - name: AZURE_STORAGE_ACCOUNT_NAME
        value: $(AZURE_STORAGE_ACCOUNT_NAME)
      - name: FRONTEND_URL
        value: $(WEB_URL)

  web:
    project: ./azure-upload-file-storage/app
    language: js
    host: staticwebapp
    dist: dist
    buildCommand: npm run build
    env:
      - name: VITE_API_URL
        value: $(API_URL)

hooks:
  preprovision:
    posix:
      shell: sh
      run: |
        echo "ðŸš€ Starting Azure resource provisioning..."
        echo "This will create:"
        echo "  - Azure Container Apps (API)"
        echo "  - Azure Static Web App (Frontend)"
        echo "  - Azure Storage Account (Blob storage)"
        echo "  - Managed Identity + RBAC roles"
    windows:
      shell: pwsh
      run: |
        Write-Host "ðŸš€ Starting Azure resource provisioning..."
        Write-Host "This will create:"
        Write-Host "  - Azure Container Apps (API)"
        Write-Host "  - Azure Static Web App (Frontend)"
        Write-Host "  - Azure Storage Account (Blob storage)"
        Write-Host "  - Managed Identity + RBAC roles"

  postprovision:
    posix:
      shell: sh
      run: |
        echo "ðŸ“ Configuring environment..."
        
        # Get environment values
        azd env get-values > .env
        
        # Get storage account name
        STORAGE_ACCOUNT=$(azd env get-value AZURE_STORAGE_ACCOUNT_NAME)
        echo "Storage Account: $STORAGE_ACCOUNT"
        
        # Create upload container if it doesn't exist
        echo "Creating 'upload' container..."
        az storage container create \
          --name upload \
          --account-name "$STORAGE_ACCOUNT" \
          --auth-mode login \
          --only-show-errors || echo "Container already exists"
        
        echo "âœ… Environment configured successfully"
    windows:
      shell: pwsh
      run: |
        Write-Host "ðŸ“ Configuring environment..."
        
        # Get environment values
        azd env get-values > .env
        
        # Get storage account name
        $STORAGE_ACCOUNT = azd env get-value AZURE_STORAGE_ACCOUNT_NAME
        Write-Host "Storage Account: $STORAGE_ACCOUNT"
        
        # Create upload container if it doesn't exist
        Write-Host "Creating 'upload' container..."
        az storage container create `
          --name upload `
          --account-name "$STORAGE_ACCOUNT" `
          --auth-mode login `
          --only-show-errors
        
        Write-Host "âœ… Environment configured successfully"

  postdeploy:
    posix:
      shell: sh
      run: |
        echo "ðŸ”§ Finalizing deployment..."
        
        # Get deployment URLs
        API_URL=$(azd env get-value API_URL)
        WEB_URL=$(azd env get-value WEB_URL)
        
        echo ""
        echo "ðŸŽ‰ Deployment successful!"
        echo ""
        echo "Application URLs:"
        echo "  Frontend: $WEB_URL"
        echo "  API:      $API_URL"
        echo ""
        echo "Next steps:"
        echo "  1. Open the frontend URL in your browser"
        echo "  2. Test file upload functionality"
        echo "  3. View logs: azd logs"
        echo ""
    windows:
      shell: pwsh
      run: |
        Write-Host "ðŸ”§ Finalizing deployment..."
        
        # Get deployment URLs
        $API_URL = azd env get-value API_URL
        $WEB_URL = azd env get-value WEB_URL
        
        Write-Host ""
        Write-Host "ðŸŽ‰ Deployment successful!"
        Write-Host ""
        Write-Host "Application URLs:"
        Write-Host "  Frontend: $WEB_URL"
        Write-Host "  API:      $API_URL"
        Write-Host ""
        Write-Host "Next steps:"
        Write-Host "  1. Open the frontend URL in your browser"
        Write-Host "  2. Test file upload functionality"
        Write-Host "  3. View logs: azd logs"
        Write-Host ""
