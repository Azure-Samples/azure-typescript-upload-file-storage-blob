%% Simplified SAS Token Flow
%% High-level overview of User Delegation SAS pattern

sequenceDiagram
    participant User as ðŸ‘¤ User
    participant Frontend as React App
    participant API as Fastify API
    participant Azure as Azure Services
    
    %% Select File
    User->>Frontend: ðŸ‘† 1. SELECT FILE
    Frontend->>Frontend: 2. File selected & validated
    
    %% Request SAS Token
    User->>Frontend: ðŸ‘† 3. GET SAS TOKEN
    Frontend->>API: 4. Request SAS token<br/>GET /api/sas
    
    %% Generate SAS Token
    Note over API,Azure: Authenticate & Generate SAS
    API->>Azure: 5. Authenticate with<br/>Managed Identity
    Azure-->>API: 6. Return User Delegation Key
    API->>API: 7. Generate SAS URL<br/>with time-limited permissions
    API-->>Frontend: 8. Return SAS URL
    Frontend->>Frontend: 9. Store SAS URL
    
    %% Upload File
    Note over User,Azure: Browser uploads directly to Storage<br/>(NOT through API)
    User->>Frontend: ðŸ‘† 10. UPLOAD FILE
    User->>Azure: 11. PUT *.PNG directly to Blob Storage<br/>using SAS URL (bypasses API)
    Azure->>Azure: 12. Validate SAS<br/>& permissions
    Azure-->>User: 13. Upload complete
    
    %% Confirm Success
    User->>Frontend: 14. View uploaded files
    Frontend->>API: 15. List uploaded files
    API->>Azure: 16. Query Blob Storage
    Azure-->>API: 17. Return file list
    API-->>Frontend: 18. Return files
    Frontend->>User: 19. Show success
    
    %% Key Benefits
    Note over User,Azure: âœ… Keyless (Managed Identity)<br/>âœ… Time-Limited Access<br/>âœ… Direct Upload (no API proxy)
