%% Application Architecture: Azure File Upload System
%% Shows component interactions, data flow, and SAS token generation

graph TB
    %% User and Frontend
    User[ðŸ‘¤ User] --> Frontend[React Frontend<br/>Vite + Material-UI<br/>Port 5173/8080]
    
    %% Frontend interactions with API
    Frontend -->|1. Request SAS Token<br/>GET /api/sas| API
    Frontend -->|3. Upload File<br/>PUT with SAS URL| Storage
    Frontend -->|4. List Files<br/>GET /api/list| API
    
    %% API Server
    subgraph "API Server (Fastify)"
        API[API Routes<br/>Port 3000]
        API --> SASRoute[SAS Token Route<br/>/api/sas]
        API --> ListRoute[List Files Route<br/>/api/list]
        API --> StatusRoute[Status Route<br/>/api/status]
        API --> HealthRoute[Health Check<br/>/health]
        
        SASRoute --> AzureStorage[Azure Storage Client<br/>@azure/storage-blob]
        ListRoute --> AzureStorage
        StatusRoute --> AzureStorage
        
        AzureStorage --> Credential[DefaultAzureCredential<br/>@azure/identity]
    end
    
    %% Azure Services
    subgraph "Azure Services"
        Credential -.Authenticates with.-> ManagedIdentity[Managed Identity<br/>User-Assigned]
        ManagedIdentity -.RBAC: Storage Blob<br/>Data Contributor.-> Storage
        ManagedIdentity -.RBAC: Storage<br/>Blob Delegator.-> Storage
        
        Storage[(Azure Blob Storage<br/>StorageV2<br/>Container: 'upload')]
        
        ManagedIdentity -.Provides identity to.-> API
    end
    
    %% SAS Token Generation Flow (detailed)
    SASRoute -->|2a. Request User<br/>Delegation Key| Storage
    Storage -->|2b. Return User<br/>Delegation Key| SASRoute
    SASRoute -->|2c. Generate SAS<br/>signed with key| SASToken[SAS Token URL<br/>Time-limited<br/>Permission-scoped]
    SASToken -->|2d. Return to client| Frontend
    
    %% Styling
    classDef userClass fill:#E1F5FF,stroke:#0078D4,stroke-width:2px
    classDef frontendClass fill:#FFF4E1,stroke:#FF8C00,stroke-width:2px
    classDef apiClass fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px
    classDef azureClass fill:#F3E5F5,stroke:#9C27B0,stroke-width:2px
    classDef storageClass fill:#E3F2FD,stroke:#2196F3,stroke-width:3px
    classDef securityClass fill:#FFEBEE,stroke:#F44336,stroke-width:2px
    
    class User userClass
    class Frontend frontendClass
    class API,SASRoute,ListRoute,StatusRoute,HealthRoute,AzureStorage apiClass
    class Storage storageClass
    class Credential,ManagedIdentity,SASToken securityClass
