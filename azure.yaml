# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json
name: azure-typescript-upload-file-storage-blob
metadata:
  template: azd-init@1.22.2

workflows:
  up: 
    steps:
      - azd: provision
      - azd: deploy api
      - azd: deploy app

# alphabetic ordering of packaging
services:
  api:
    project: ./packages/api
    host: containerapp
    language: ts
    docker:
      path: ./Dockerfile
      context: ./
  
  app:
    project: ./packages/app
    host: containerapp
    language: ts
    docker:
      path: ./Dockerfile
      context: ./
      buildArgs:
        - "VITE_API_URL=${API_URL}"

hooks:
  postprovision:
    posix:
      shell: sh
      run: |
        echo "üìù Configuring environment..."
        azd env get-values > .env
        echo "Environment file created"
        
        echo "‚è≥ Waiting 30 seconds for RBAC role propagation..."
        sleep 30
        echo "‚úÖ Ready for deployment"
    windows:
      shell: pwsh
      run: |
        Write-Host "üìù Configuring environment..."
        azd env get-values > .env
        Write-Host "Environment file created"
        
        Write-Host "‚è≥ Waiting 30 seconds for RBAC role propagation..."
        Start-Sleep -Seconds 30
        Write-Host "‚úÖ Ready for deployment"

  postdeploy:
    posix:
      shell: sh
      run: |
        RESOURCE_GROUP=$(azd env get-value AZURE_RESOURCE_GROUP)
        WEB_URL=$(azd env get-value WEB_URL)
        API_NAME=$(az containerapp list --resource-group "$RESOURCE_GROUP" --query "[?tags.\"azd-service-name\"=='api'].name" -o tsv)
        
        echo "üîß Setting API CORS to allow: $WEB_URL"
        az containerapp ingress cors update \
          --name "$API_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --allowed-origins "$WEB_URL" \
          --allowed-methods GET POST PUT DELETE OPTIONS \
          --allowed-headers "*" \
          --max-age 3600
    windows:
      shell: pwsh
      run: |
        $RESOURCE_GROUP = azd env get-value AZURE_RESOURCE_GROUP
        $WEB_URL = azd env get-value WEB_URL
        $API_NAME = az containerapp list --resource-group "$RESOURCE_GROUP" --query "[?tags.\`"azd-service-name\`"=='api'].name" -o tsv
        
        Write-Host "üîß Setting API CORS to allow: $WEB_URL"
        az containerapp ingress cors update `
          --name $API_NAME `
          --resource-group $RESOURCE_GROUP `
          --allowed-origins $WEB_URL `
          --allowed-methods GET POST PUT DELETE OPTIONS `
          --allowed-headers "*" `
          --max-age 3600

  postdown:
    posix:
      shell: sh
      run: |
        echo "üßπ Cleaning up environment files..."
        if [ -f .env ]; then
          rm .env
          echo "Deleted .env file"
        else
          echo "No .env file to delete"
        fi
    windows:
      shell: pwsh
      run: |
        Write-Host "üßπ Cleaning up environment files..."
        if (Test-Path .env) {
          Remove-Item .env
          Write-Host "Deleted .env file"
        } else {
          Write-Host "No .env file to delete"
        }
